{% load static %}

{% load humanize %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Account Activity</title>

<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f5f7fb;
            margin: 0;
            padding: 0;
            color: #222;
        }

        .activity-page {
            padding: 30px 0;
        }

        .container {
            width: 92%;
            margin: auto;
        }

        h2 {
            font-size: 30px;
            font-weight: 600;
            margin-bottom: 18px;
            color: #111;
        }

        /* Controls Section */
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 18px;
            align-items: center;
        }

        .controls input, .controls button {
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        .controls button {
            background: #2563eb;
            color: white;
            cursor: pointer;
            border: none;
        }

        .controls button:hover {
            background: #1d4ed8;
        }
        /* Searchbar Wrapper */
.search-wrapper {
    position: relative;
    width: 380px;
}

.search-wrapper input {
    width: 100%;
    padding: 10px 14px 10px 38px;  /* left padding for icon */
    border-radius: 8px;
    border: 1px solid #d0d7e2;
    background: #ffffff;
    font-size: 14px;
    transition: 0.2s ease-in-out;
    outline: none;
}

/* Search Icon */
.search-wrapper .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 17px;
    color: #6b7280;
}

/* Focus Effect */
.search-wrapper input:focus {
    border-color: #2563eb;
    box-shadow: 0 0 8px rgba(37, 99, 235, 0.2);
}

/* Hover Effect */
.search-wrapper input:hover {
    border-color: #9ca3af;
}


        .table-container {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 5px 20px #00000010;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: #222;
        }

        thead {
            background: #e8edf5;
        }

        thead th {
            padding: 14px;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            border-bottom: 2px solid #d0d7e2;
        }

        tbody tr:hover {
            background: #f1f4f9;
        }

        tbody td {
            padding: 14px;
            font-size: 14px;
            border-bottom: 1px solid #efefef;
        }

        .type-tag {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: white;
        }

        .cash {
            background: #10b981;
        }

        .saving {
            background: #3b82f6;
        }

        .acc-number-tag {
            background: #eef1f7;
            padding: 6px 10px;
            border-radius: 6px;
            color: #444;
        }

        .pagination {
            margin-top: 15px;
            text-align: center;
        }

        .pagination button {
            padding: 8px 12px;
            background: #2563eb;
            border: none;
            color: white;
            border-radius: 6px;
            margin: 0 5px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #1d4ed8;
        }

        @media print {
            .controls, .pagination {
                display: none;
            }
            body {
                background: white !important;
            }
            .table-container {
                box-shadow: none;
            }
        }
    </style>
</head>

<body>
  <div class="top-nav">
    <div class="top-nav-container">
        
        <!-- Left Section -->
        <div class="nav-left">
            <div class="logo">
                <h1 class="logo">
                    <span class="f">F</span>
                    <span class="e">e</span>
                    <span class="d">d</span>
                    <span class="i">I</span>
                    <span class="n">n</span>
                    <span class="v">v</span>
                    <span class="e2">e</span>
                    <span class="s">s</span>
                    <span class="t">t</span>
                </h1>
            </div>

            <nav class="main-nav">
                <a href="{% url 'holdings' %}" class="active erbtn">All accounts</a>
                <a href="#" class="erbtn">Personal Advisor Services</a>
            </nav>
        </div>

        <!-- Right Navigation Icons -->
        <div class="nav-right">

            <a href="#" class="nav-item erbtn">
                <svg viewBox="0 0 24 24">
                    <circle cx="10.5" cy="10.5" r="7.5"></circle>
                    <line x1="21" y1="21" x2="15.8" y2="15.8"></line>
                </svg>
                <span>Search</span>
            </a>

            <a href="#" class="nav-item erbtn">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"></circle>
                    <text x="12" y="16" font-size="12" text-anchor="middle" fill="none" stroke="#000" stroke-width="0.5">?</text>
                </svg>
                <span>Support</span>
            </a>

            <a href="{% url 'messages' %}" class="nav-item erbtn">
                <svg viewBox="0 0 24 24">
                    <rect x="3" y="5" width="18" height="14" rx="2" ry="2"></rect>
                    <polyline points="3,7 12,13 21,7"></polyline>
                </svg>
                <div class="badge"></div>
                <span>Messages</span>
            </a>

            <a href="{% url 'legal_documents' %}" class="nav-item erbtn">
                <svg viewBox="0 0 24 24">
                    <rect x="6" y="4" width="12" height="16" rx="1"></rect>
                    <line x1="6" y1="8" x2="18" y2="8"></line>
                </svg>
                <span>Documents</span>
            </a>

            <a href="{% url 'get_profile' request.user.id %}" class="nav-item erbtn">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="8" r="4"></circle>
                    <path d="M4 20c0-4 4-6 8-6s8 2 8 6"></path>
                </svg>
                <span>Profile</span>
            </a>

            <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
        </div>

    </div>
</div>

<!-- SECONDARY NAV -->
<div class="secondary-nav">
    <div class="secondary-nav-container">
        <nav>
            <a class="erbtn" href="{% url 'dashboard' %}">Dashboard</a>
            <a class="erbtn" href="{% url 'holdings' %}">Holdings</a>
            <a class="erbtn" href="{% url 'balance' %}">Balances</a>
            <a class="erbtn" href="{% url 'activity' %}">Activity</a>
            <a class="erbtn" href="{% url 'performance' %}">Performance</a>
        </nav>
    </div>
</div>



<div class="activity-page">
    <div class="container">

        <h2>Account Activity</h2>

       <div class="controls">
    <div class="search-wrapper">
<span class="search-icon">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
</span>
        <input type="text" id="searchInput" placeholder="Search by account type or account number...">
    </div>

            <button onclick="applyFilters()">Apply Filters</button>
            <button onclick="resetFilters()">Reset</button>
            <button onclick="exportCSV()">Export CSV</button>
            <button onclick="exportPDF()">Export PDF</button>
            <button onclick="window.print()">Print Page</button>
        </div>

        <div class="table-container">
            <table id="activityTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Date</th>
                        <th onclick="sortTable(1)">Account Type</th>
                        <th onclick="sortTable(2)">Account Number</th>
                        <th onclick="sortTable(3)">Credit</th>
                        <th onclick="sortTable(4)">Debit</th>
                        <th onclick="sortTable(5)">Balance</th>
                    </tr>
                </thead>

                <tbody id="tableBody">
                {% for e in entries %}
                    <tr>
                        <td>{{ e.date }}</td>

                        <td>
                            <span class="type-tag {% if e.entry_type == 'Cash Account' %}cash{% else %}saving{% endif %}">
                                {{ e.entry_type }}
                            </span>
                        </td>

                        <td><span class="acc-number-tag">{{ e.account_number }}</span></td>
                        <td>${{ e.credit|intcomma }}</td>
                        <td>${{ e.debit|intcomma }}</td>
                        <td>${{ e.balance|intcomma }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="6" class="empty-state">No activity found.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <button onclick="prevPage()">Prev</button>
            <span id="pageNum">1</span>
            <button onclick="nextPage()">Next</button>
        </div>

    </div>
</div>

<!-- PDF Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<script>
/* ----------------------------
   SEARCH + FILTER FUNCTIONS
----------------------------- */
function applyFilters() {
    let search = document.getElementById("searchInput").value.toLowerCase();
    let rows = document.querySelectorAll("#tableBody tr");

    rows.forEach(row => {
        let text = row.innerText.toLowerCase();
        row.style.display = (search && !text.includes(search)) ? "none" : "";
    });
}

function resetFilters() {
    document.getElementById("searchInput").value = "";
    applyFilters();
}

/* -------------------------------
   Trigger filter on ENTER key
-------------------------------- */
document.getElementById("searchInput").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        event.preventDefault();  // stops form submit if inside a form
        applyFilters();          // run search
    }
});

/* ----------------------------
   SORT TABLE
----------------------------- */
let sortAsc = true;
function sortTable(col) {
    let table = document.getElementById("activityTable");
    let rows = Array.from(table.rows).slice(1);

    rows.sort((a, b) => {
        let x = a.cells[col].innerText.replace(/[$,]/g, "");
        let y = b.cells[col].innerText.replace(/[$,]/g, "");
        return sortAsc ? x.localeCompare(y) : y.localeCompare(x);
    });

    sortAsc = !sortAsc;

    rows.forEach(r => table.appendChild(r));
}

/* ----------------------------
   PAGINATION
----------------------------- */
let currentPage = 1;
let rowsPerPage = 10;

function paginate() {
    let rows = document.querySelectorAll("#tableBody tr");
    let start = (currentPage - 1) * rowsPerPage;
    let end = start + rowsPerPage;

    rows.forEach((row, index) => {
        row.style.display = (index >= start && index < end) ? "" : "none";
    });

    document.getElementById("pageNum").innerText = currentPage;
}

function nextPage() {
    let rows = document.querySelectorAll("#tableBody tr");
    if (currentPage * rowsPerPage < rows.length) {
        currentPage++;
        paginate();
    }
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        paginate();
    }
}

paginate();

/* ----------------------------
   EXPORT CSV
----------------------------- */
function exportCSV() {
    let rows = document.querySelectorAll("#activityTable tr");
    let csv = [];

    rows.forEach(row => {
        let cols = Array.from(row.querySelectorAll("th,td")).map(c => c.innerText.replace(/,/g, ""));
        csv.push(cols.join(","));
    });

    let blob = new Blob([csv.join("\n")], { type: "text/csv" });
    let link = document.createElement("a");
    link.href = window.URL.createObjectURL(blob);
    link.download = "account_activity.csv";
    link.click();
}

/* ----------------------------
   EXPORT PDF
----------------------------- */
function exportPDF() {
    let element = document.querySelector(".activity-page");
    html2pdf().from(element).save("Account_Activity.pdf");
}
</script>
<script src="{% static 'js/main.js' %}"></script>

</body>
</html>
